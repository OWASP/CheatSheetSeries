
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Website with the collection of all the cheat sheets of the project.">
      
      
      
      
        <link rel="canonical" href="https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html">
      
      <link rel="shortcut icon" href="../assets/WebSite_Favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>HTML5 Security - OWASP Cheat Sheet Series</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.75751829.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-4531126-15","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#html5-security-cheat-sheet" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://cheatsheetseries.owasp.org/" title="OWASP Cheat Sheet Series" class="md-header-nav__button md-logo" aria-label="OWASP Cheat Sheet Series">
      
  <img src="../assets/OWASP_Logo_Transp.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            OWASP Cheat Sheet Series
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              HTML5 Security
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/OWASP/CheatSheetSeries" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/CheatSheetSeries
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://cheatsheetseries.owasp.org/" title="OWASP Cheat Sheet Series" class="md-nav__button md-logo" aria-label="OWASP Cheat Sheet Series">
      
  <img src="../assets/OWASP_Logo_Transp.png" alt="logo">

    </a>
    OWASP Cheat Sheet Series
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/OWASP/CheatSheetSeries" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/CheatSheetSeries
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="../index.html" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../Glossary.html" class="md-nav__link">
      Index Alphabetical
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../IndexASVS.html" class="md-nav__link">
      Index ASVS
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../IndexProactiveControls.html" class="md-nav__link">
      Index Proactive Controls
    </a>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Cheatsheets
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Cheatsheets" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Cheatsheets
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="AJAX_Security_Cheat_Sheet.html" class="md-nav__link">
      AJAX Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Abuse_Case_Cheat_Sheet.html" class="md-nav__link">
      Abuse Case
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Access_Control_Cheat_Sheet.html" class="md-nav__link">
      Access Control
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Attack_Surface_Analysis_Cheat_Sheet.html" class="md-nav__link">
      Attack Surface Analysis
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Authentication_Cheat_Sheet.html" class="md-nav__link">
      Authentication
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Authorization_Testing_Automation_Cheat_Sheet.html" class="md-nav__link">
      Authorization Testing Automation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Bean_Validation_Cheat_Sheet.html" class="md-nav__link">
      Bean Validation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="C-Based_Toolchain_Hardening_Cheat_Sheet.html" class="md-nav__link">
      C-Based Toolchain Hardening
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Choosing_and_Using_Security_Questions_Cheat_Sheet.html" class="md-nav__link">
      Choosing and Using Security Questions
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Clickjacking_Defense_Cheat_Sheet.html" class="md-nav__link">
      Clickjacking Defense
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Content_Security_Policy_Cheat_Sheet.html" class="md-nav__link">
      Content Security Policy
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Credential_Stuffing_Prevention_Cheat_Sheet.html" class="md-nav__link">
      Credential Stuffing Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" class="md-nav__link">
      Cross-Site Request Forgery Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Cross_Site_Scripting_Prevention_Cheat_Sheet.html" class="md-nav__link">
      Cross Site Scripting Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Cryptographic_Storage_Cheat_Sheet.html" class="md-nav__link">
      Cryptographic Storage
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="DOM_based_XSS_Prevention_Cheat_Sheet.html" class="md-nav__link">
      DOM based XSS Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Database_Security_Cheat_Sheet.html" class="md-nav__link">
      Database Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Denial_of_Service_Cheat_Sheet.html" class="md-nav__link">
      Denial of Service
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Deserialization_Cheat_Sheet.html" class="md-nav__link">
      Deserialization
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Docker_Security_Cheat_Sheet.html" class="md-nav__link">
      Docker Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="DotNet_Security_Cheat_Sheet.html" class="md-nav__link">
      DotNet Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Error_Handling_Cheat_Sheet.html" class="md-nav__link">
      Error Handling
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="File_Upload_Cheat_Sheet.html" class="md-nav__link">
      File Upload
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Forgot_Password_Cheat_Sheet.html" class="md-nav__link">
      Forgot Password
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="GraphQL_Cheat_Sheet.html" class="md-nav__link">
      GraphQL
    </a>
  </li>

        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        HTML5 Security
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="HTML5_Security_Cheat_Sheet.html" class="md-nav__link md-nav__link--active">
      HTML5 Security
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#communication-apis" class="md-nav__link">
    Communication APIs
  </a>
  
    <nav class="md-nav" aria-label="Communication APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web-messaging" class="md-nav__link">
    Web Messaging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-origin-resource-sharing" class="md-nav__link">
    Cross Origin Resource Sharing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websockets" class="md-nav__link">
    WebSockets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-sent-events" class="md-nav__link">
    Server-Sent Events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-apis" class="md-nav__link">
    Storage APIs
  </a>
  
    <nav class="md-nav" aria-label="Storage APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-storage" class="md-nav__link">
    Local Storage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-side-databases" class="md-nav__link">
    Client-side databases
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geolocation" class="md-nav__link">
    Geolocation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-workers" class="md-nav__link">
    Web Workers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tabnabbing" class="md-nav__link">
    Tabnabbing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sandboxed-frames" class="md-nav__link">
    Sandboxed frames
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credential-and-personally-identifiable-information-pii-input-hints" class="md-nav__link">
    Credential and Personally Identifiable Information (PII) Input hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#offline-applications" class="md-nav__link">
    Offline Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#progressive-enhancements-and-graceful-degradation-risks" class="md-nav__link">
    Progressive Enhancements and Graceful Degradation Risks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-headers-to-enhance-security" class="md-nav__link">
    HTTP Headers to enhance security
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket-implementation-hints" class="md-nav__link">
    WebSocket implementation hints
  </a>
  
    <nav class="md-nav" aria-label="WebSocket implementation hints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-filtering" class="md-nav__link">
    Access filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-and-inputoutput-validation" class="md-nav__link">
    Authentication and Input/Output validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authorization-and-access-token-explicit-invalidation" class="md-nav__link">
    Authorization and access token explicit invalidation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confidentiality-and-integrity" class="md-nav__link">
    Confidentiality and Integrity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="HTTP_Strict_Transport_Security_Cheat_Sheet.html" class="md-nav__link">
      HTTP Strict Transport Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Injection_Prevention_Cheat_Sheet.html" class="md-nav__link">
      Injection Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Injection_Prevention_in_Java_Cheat_Sheet.html" class="md-nav__link">
      Injection Prevention in Java
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Input_Validation_Cheat_Sheet.html" class="md-nav__link">
      Input Validation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html" class="md-nav__link">
      Insecure Direct Object Reference Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="JAAS_Cheat_Sheet.html" class="md-nav__link">
      JAAS
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="JSON_Web_Token_for_Java_Cheat_Sheet.html" class="md-nav__link">
      JSON Web Token for Java
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Key_Management_Cheat_Sheet.html" class="md-nav__link">
      Key Management
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Kubernetes_Security_Cheat_Sheet.html" class="md-nav__link">
      Kubernetes Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="LDAP_Injection_Prevention_Cheat_Sheet.html" class="md-nav__link">
      LDAP Injection Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Logging_Cheat_Sheet.html" class="md-nav__link">
      Logging
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Mass_Assignment_Cheat_Sheet.html" class="md-nav__link">
      Mass Assignment
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Microservices_based_Security_Arch_Doc_Cheat_Sheet.html" class="md-nav__link">
      Microservices based Security Arch Doc
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Microservices_security.html" class="md-nav__link">
      Microservices security.md
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Multifactor_Authentication_Cheat_Sheet.html" class="md-nav__link">
      Multifactor Authentication
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Nodejs_Security_Cheat_Sheet.html" class="md-nav__link">
      Nodejs Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="OS_Command_Injection_Defense_Cheat_Sheet.html" class="md-nav__link">
      OS Command Injection Defense
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="PHP_Configuration_Cheat_Sheet.html" class="md-nav__link">
      PHP Configuration
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Password_Storage_Cheat_Sheet.html" class="md-nav__link">
      Password Storage
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Pinning_Cheat_Sheet.html" class="md-nav__link">
      Pinning
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Query_Parameterization_Cheat_Sheet.html" class="md-nav__link">
      Query Parameterization
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="REST_Assessment_Cheat_Sheet.html" class="md-nav__link">
      REST Assessment
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="REST_Security_Cheat_Sheet.html" class="md-nav__link">
      REST Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Ruby_on_Rails_Cheat_Sheet.html" class="md-nav__link">
      Ruby on Rails
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="SAML_Security_Cheat_Sheet.html" class="md-nav__link">
      SAML Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="SQL_Injection_Prevention_Cheat_Sheet.html" class="md-nav__link">
      SQL Injection Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Securing_Cascading_Style_Sheets_Cheat_Sheet.html" class="md-nav__link">
      Securing Cascading Style Sheets
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html" class="md-nav__link">
      Server Side Request Forgery Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Session_Management_Cheat_Sheet.html" class="md-nav__link">
      Session Management
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="TLS_Cipher_String_Cheat_Sheet.html" class="md-nav__link">
      TLS Cipher String
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Third_Party_Javascript_Management_Cheat_Sheet.html" class="md-nav__link">
      Third Party Javascript Management
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Threat_Modeling_Cheat_Sheet.html" class="md-nav__link">
      Threat Modeling
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Transaction_Authorization_Cheat_Sheet.html" class="md-nav__link">
      Transaction Authorization
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Transport_Layer_Protection_Cheat_Sheet.html" class="md-nav__link">
      Transport Layer Protection
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html" class="md-nav__link">
      Unvalidated Redirects and Forwards
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="User_Privacy_Protection_Cheat_Sheet.html" class="md-nav__link">
      User Privacy Protection
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Virtual_Patching_Cheat_Sheet.html" class="md-nav__link">
      Virtual Patching
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Vulnerability_Disclosure_Cheat_Sheet.html" class="md-nav__link">
      Vulnerability Disclosure
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Vulnerable_Dependency_Management_Cheat_Sheet.html" class="md-nav__link">
      Vulnerable Dependency Management
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="Web_Service_Security_Cheat_Sheet.html" class="md-nav__link">
      Web Service Security
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="XML_External_Entity_Prevention_Cheat_Sheet.html" class="md-nav__link">
      XML External Entity Prevention
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="XML_Security_Cheat_Sheet.html" class="md-nav__link">
      XML Security
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#communication-apis" class="md-nav__link">
    Communication APIs
  </a>
  
    <nav class="md-nav" aria-label="Communication APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web-messaging" class="md-nav__link">
    Web Messaging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-origin-resource-sharing" class="md-nav__link">
    Cross Origin Resource Sharing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websockets" class="md-nav__link">
    WebSockets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-sent-events" class="md-nav__link">
    Server-Sent Events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-apis" class="md-nav__link">
    Storage APIs
  </a>
  
    <nav class="md-nav" aria-label="Storage APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-storage" class="md-nav__link">
    Local Storage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-side-databases" class="md-nav__link">
    Client-side databases
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geolocation" class="md-nav__link">
    Geolocation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-workers" class="md-nav__link">
    Web Workers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tabnabbing" class="md-nav__link">
    Tabnabbing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sandboxed-frames" class="md-nav__link">
    Sandboxed frames
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credential-and-personally-identifiable-information-pii-input-hints" class="md-nav__link">
    Credential and Personally Identifiable Information (PII) Input hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#offline-applications" class="md-nav__link">
    Offline Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#progressive-enhancements-and-graceful-degradation-risks" class="md-nav__link">
    Progressive Enhancements and Graceful Degradation Risks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-headers-to-enhance-security" class="md-nav__link">
    HTTP Headers to enhance security
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket-implementation-hints" class="md-nav__link">
    WebSocket implementation hints
  </a>
  
    <nav class="md-nav" aria-label="WebSocket implementation hints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-filtering" class="md-nav__link">
    Access filtering
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-and-inputoutput-validation" class="md-nav__link">
    Authentication and Input/Output validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authorization-and-access-token-explicit-invalidation" class="md-nav__link">
    Authorization and access token explicit invalidation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confidentiality-and-integrity" class="md-nav__link">
    Confidentiality and Integrity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="html5-security-cheat-sheet">HTML5 Security Cheat Sheet<a class="headerlink" href="#html5-security-cheat-sheet" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>The following cheat sheet serves as a guide for implementing HTML 5 in a secure fashion.</p>
<h2 id="communication-apis">Communication APIs<a class="headerlink" href="#communication-apis" title="Permanent link">&para;</a></h2>
<h3 id="web-messaging">Web Messaging<a class="headerlink" href="#web-messaging" title="Permanent link">&para;</a></h3>
<p>Web Messaging (also known as Cross Domain Messaging) provides a means of messaging between documents from different origins in a way that is generally safer than the multiple hacks used in the past to accomplish this task. However, there are still some recommendations to keep in mind:</p>
<ul>
<li>When posting a message, explicitly state the expected origin as the second argument to <code>postMessage</code> rather than <code>*</code> in order to prevent sending the message to an unknown origin after a redirect or some other means of the target window's origin changing.</li>
<li>The receiving page should <strong>always</strong>:<ul>
<li>Check the <code>origin</code> attribute of the sender to verify the data is originating from the expected location.</li>
<li>Perform input validation on the <code>data</code> attribute of the event to ensure that it's in the desired format.</li>
</ul>
</li>
<li>Don't assume you have control over the <code>data</code> attribute. A single <a href="Cross_Site_Scripting_Prevention_Cheat_Sheet.html">Cross Site Scripting</a> flaw in the sending page allows an attacker to send messages of any given format.</li>
<li>Both pages should only interpret the exchanged messages as <strong>data</strong>. Never evaluate passed messages as code (e.g. via <code>eval()</code>) or insert it to a page DOM (e.g. via <code>innerHTML</code>), as that would create a DOM-based XSS vulnerability. For more information see <a href="DOM_based_XSS_Prevention_Cheat_Sheet.html">DOM based XSS Prevention Cheat Sheet</a>.</li>
<li>To assign the data value to an element, instead of using a insecure method like <code>element.innerHTML=data;</code>, use the safer option: <code>element.textContent=data;</code></li>
<li>Check the origin properly exactly to match the FQDN(s) you expect. Note that the following code: <code>if(message.origin.indexOf(".owasp.org")!=-1) { /* ... */ }</code> is very insecure and will not have the desired behavior as <code>owasp.org.attacker.com</code> will match.</li>
<li>If you need to embed external content/untrusted gadgets and allow user-controlled scripts (which is highly discouraged), consider using a JavaScript rewriting framework such as <a href="http://code.google.com/p/google-caja/">Google Caja</a> or check the information on <a href="HTML5_Security_Cheat_Sheet.html#sandboxed-frames">sandboxed frames</a>.</li>
</ul>
<h3 id="cross-origin-resource-sharing">Cross Origin Resource Sharing<a class="headerlink" href="#cross-origin-resource-sharing" title="Permanent link">&para;</a></h3>
<ul>
<li>Validate URLs passed to <code>XMLHttpRequest.open</code>. Current browsers allow these URLs to be cross domain; this behavior can lead to code injection by a remote attacker. Pay extra attention to absolute URLs.</li>
<li>Ensure that URLs responding with <code>Access-Control-Allow-Origin: *</code> do not include any sensitive content or information that might aid attacker in further attacks. Use the <code>Access-Control-Allow-Origin</code> header only on chosen URLs that need to be accessed cross-domain. Don't use the header for the whole domain.</li>
<li>Allow only selected, trusted domains in the <code>Access-Control-Allow-Origin</code> header. Prefer whitelisting domains over blacklisting or allowing any domain (do not use <code>*</code> wildcard nor blindly return the <code>Origin</code> header content without any checks).</li>
<li>Keep in mind that CORS does not prevent the requested data from going to an unauthenticated location. It's still important for the server to perform usual <a href="Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">CSRF</a> prevention.</li>
<li>While the RFC recommends a pre-flight request with the <code>OPTIONS</code> verb, current implementations might not perform this request, so it's important that "ordinary" (<code>GET</code> and <code>POST</code>) requests perform any access control necessary.</li>
<li>Discard requests received over plain HTTP with HTTPS origins to prevent mixed content bugs.</li>
<li>Don't rely only on the Origin header for Access Control checks. Browser always sends this header in CORS requests, but may be spoofed outside the browser. Application-level protocols should be used to protect sensitive data.</li>
</ul>
<h3 id="websockets">WebSockets<a class="headerlink" href="#websockets" title="Permanent link">&para;</a></h3>
<ul>
<li>Drop backward compatibility in implemented client/servers and use only protocol versions above hybi-00. Popular Hixie-76 version (hiby-00) and older are outdated and insecure.</li>
<li>The recommended version supported in latest versions of all current browsers is <a href="http://tools.ietf.org/html/rfc6455">RFC 6455</a> (supported by Firefox 11+, Chrome 16+, Safari 6, Opera 12.50, and IE10).</li>
<li>While it's relatively easy to tunnel TCP services through WebSockets (e.g. VNC, FTP), doing so enables access to these tunneled services for the in-browser attacker in case of a Cross Site Scripting attack. These services might also be called directly from a malicious page or program.</li>
<li>The protocol doesn't handle authorization and/or authentication. Application-level protocols should handle that separately in case sensitive data is being transferred.</li>
<li>Process the messages received by the websocket as data. Don't try to assign it directly to the DOM nor evaluate as code. If the response is JSON, never use the insecure <code>eval()</code> function; use the safe option JSON.parse() instead.</li>
<li>Endpoints exposed through the <code>ws://</code> protocol are easily reversible to plain text. Only <code>wss://</code> (WebSockets over SSL/TLS) should be used for protection against Man-In-The-Middle attacks.</li>
<li>Spoofing the client is possible outside a browser, so the WebSockets server should be able to handle incorrect/malicious input. Always validate input coming from the remote site, as it might have been altered.</li>
<li>When implementing servers, check the <code>Origin:</code> header in the Websockets handshake. Though it might be spoofed outside a browser, browsers always add the Origin of the page that initiated the Websockets connection.</li>
<li>As a WebSockets client in a browser is accessible through JavaScript calls, all Websockets communication can be spoofed or hijacked through <a href="https://owasp.org/www-community/attacks/xss/">Cross Site Scripting</a>. Always validate data coming through a WebSockets connection.</li>
</ul>
<h3 id="server-sent-events">Server-Sent Events<a class="headerlink" href="#server-sent-events" title="Permanent link">&para;</a></h3>
<ul>
<li>Validate URLs passed to the <code>EventSource</code> constructor, even though only same-origin URLs are allowed.</li>
<li>As mentioned before, process the messages (<code>event.data</code>) as data and never evaluate the content as HTML or script code.</li>
<li>Always check the origin attribute of the message (<code>event.origin</code>) to ensure the message is coming from a trusted domain. Use a whitelist approach.</li>
</ul>
<h2 id="storage-apis">Storage APIs<a class="headerlink" href="#storage-apis" title="Permanent link">&para;</a></h2>
<h3 id="local-storage">Local Storage<a class="headerlink" href="#local-storage" title="Permanent link">&para;</a></h3>
<ul>
<li>Also known as Offline Storage, Web Storage. Underlying storage mechanism may vary from one user agent to the next. In other words, any authentication your application requires can be bypassed by a user with local privileges to the machine on which the data is stored. Therefore, it's recommended not to store any sensitive information in local storage.</li>
<li>Use the object sessionStorage instead of localStorage if persistent storage is not needed. sessionStorage object is available only to that window/tab until the window is closed.</li>
<li>A single <a href="https://owasp.org/www-community/attacks/xss/">Cross Site Scripting</a> can be used to steal all the data in these objects, so again it's recommended not to store sensitive information in local storage.</li>
<li>A single <a href="https://owasp.org/www-community/attacks/xss/">Cross Site Scripting</a> can be used to load malicious data into these objects too, so don't consider objects in these to be trusted.</li>
<li>Pay extra attention to "localStorage.getItem" and "setItem" calls implemented in HTML5 page. It helps in detecting when developers build solutions that put sensitive information in local storage, which is a bad practice.</li>
<li>Do not store session identifiers in local storage as the data is always accessible by JavaScript. Cookies can mitigate this risk using the <code>httpOnly</code> flag.</li>
<li>There is no way to restrict the visibility of an object to a specific path like with the attribute path of HTTP Cookies, every object is shared within an origin and protected with the Same Origin Policy. Avoid host multiple applications on the same origin, all of them would share the same localStorage object, use different subdomains instead.</li>
</ul>
<h3 id="client-side-databases">Client-side databases<a class="headerlink" href="#client-side-databases" title="Permanent link">&para;</a></h3>
<ul>
<li>On November 2010, the W3C announced Web SQL Database (relational SQL database) as a deprecated specification. A new standard Indexed Database API or IndexedDB (formerly WebSimpleDB) is actively developed, which provides key-value database storage and methods for performing advanced queries.</li>
<li>Underlying storage mechanisms may vary from one user agent to the next. In other words, any authentication your application requires can be bypassed by a user with local privileges to the machine on which the data is stored. Therefore, it's recommended not to store any sensitive information in local storage.</li>
<li>If utilized, WebDatabase content on the client side can be vulnerable to SQL injection and needs to have proper validation and parameterization.</li>
<li>Like Local Storage, a single <a href="https://owasp.org/www-community/attacks/xss/">Cross Site Scripting</a> can be used to load malicious data into a web database as well. Don't consider data in these to be trusted.</li>
</ul>
<h2 id="geolocation">Geolocation<a class="headerlink" href="#geolocation" title="Permanent link">&para;</a></h2>
<ul>
<li>The Geolocation RFC recommends that the user agent ask the user's permission before calculating location. Whether or how this decision is remembered varies from browser to browser. Some user agents require the user to visit the page again in order to turn off the ability to get the user's location without asking, so for privacy reasons, it's recommended to require user input before calling <code>getCurrentPosition</code> or <code>watchPosition</code>.</li>
</ul>
<h2 id="web-workers">Web Workers<a class="headerlink" href="#web-workers" title="Permanent link">&para;</a></h2>
<ul>
<li>Web Workers are allowed to use <code>XMLHttpRequest</code> object to perform in-domain and Cross Origin Resource Sharing requests. See relevant section of this Cheat Sheet to ensure CORS security.</li>
<li>While Web Workers don't have access to DOM of the calling page, malicious Web Workers can use excessive CPU for computation, leading to Denial of Service condition or abuse Cross Origin Resource Sharing for further exploitation. Ensure code in all Web Workers scripts is not malevolent. Don't allow creating Web Worker scripts from user supplied input.</li>
<li>Validate messages exchanged with a Web Worker. Do not try to exchange snippets of JavaScript for evaluation e.g. via <code>eval()</code> as that could introduce a <a href="DOM_based_XSS_Prevention_Cheat_Sheet.html">DOM Based XSS</a> vulnerability.</li>
</ul>
<h2 id="tabnabbing">Tabnabbing<a class="headerlink" href="#tabnabbing" title="Permanent link">&para;</a></h2>
<p>Attack is described in detail in this <a href="https://owasp.org/www-community/attacks/Reverse_Tabnabbing">article</a>.</p>
<p>To summarize, it's the capacity to act on parent page's content or location from a newly opened page via the back link exposed by the <strong>opener</strong> JavaScript object instance.</p>
<p>It applies to an HTML link or a JavaScript <code>window.open</code> function using the attribute/instruction <code>target</code> to specify a <a href="https://www.w3schools.com/tags/att_a_target.asp">target loading location</a> that does not replace the current location and then makes the current window/tab available.</p>
<p>To prevent this issue, the following actions are available:</p>
<p>Cut the back link between the parent and the child pages:</p>
<ul>
<li>For HTML links:<ul>
<li>To cut this back link, add the attribute <code>rel="noopener"</code> on the tag used to create the link from the parent page to the child page. This attribute value cuts the link, but depending on the browser, lets referrer information be present in the request to the child page.</li>
<li>To also remove the referrer information use this attribute value: <code>rel="noopener noreferrer"</code>.</li>
</ul>
</li>
<li>For the JavaScript <code>window.open</code> function, add the values <code>noopener,noreferrer</code> in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/open">windowFeatures</a> parameter of the <code>window.open</code> function.</li>
</ul>
<p>As the behavior using the elements above is different between the browsers, either use an HTML link or JavaScript to open a window (or tab), then use this configuration to maximize the cross supports:</p>
<ul>
<li>For HTML links, add the attribute <code>rel="noopener noreferrer"</code> to every link.</li>
<li>For JavaScript, use this function to open a window (or tab):</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">openPopup</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">windowFeatures</span><span class="p">){</span>
  <span class="c1">//Open the popup and set the opener and referrer policy instruction</span>
  <span class="kd">var</span> <span class="nx">newWindow</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;noopener,noreferrer,&#39;</span> <span class="o">+</span> <span class="nx">windowFeatures</span><span class="p">);</span>
  <span class="c1">//Reset the opener link</span>
  <span class="nx">newWindow</span><span class="p">.</span><span class="nx">opener</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>Add the HTTP response header <code>Referrer-Policy: no-referrer</code> to every HTTP response sent by the application (<a href="https://owasp.org/www-project-secure-headers/">Header Referrer-Policy information</a>. This configuration will ensure that no referrer information is sent along with requests from the page.</li>
</ul>
<p>Compatibility matrix:</p>
<ul>
<li><a href="https://caniuse.com/#search=noopener">noopener</a></li>
<li><a href="https://caniuse.com/#search=noreferrer">noreferrer</a></li>
<li><a href="https://caniuse.com/#feat=referrer-policy">referrer-policy</a></li>
</ul>
<h2 id="sandboxed-frames">Sandboxed frames<a class="headerlink" href="#sandboxed-frames" title="Permanent link">&para;</a></h2>
<ul>
<li>Use the <code>sandbox</code> attribute of an <code>iframe</code> for untrusted content.</li>
<li>The <code>sandbox</code> attribute of an <code>iframe</code> enables restrictions on content within an <code>iframe</code>. The following restrictions are active when the <code>sandbox</code> attribute is set:<ol>
<li>All markup is treated as being from a unique origin.</li>
<li>All forms and scripts are disabled.</li>
<li>All links are prevented from targeting other browsing contexts.</li>
<li>All features that trigger automatically are blocked.</li>
<li>All plugins are disabled.</li>
</ol>
</li>
</ul>
<p>It is possible to have a <a href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox">fine-grained control</a> over <code>iframe</code> capabilities using the value of the <code>sandbox</code> attribute.</p>
<ul>
<li>In old versions of user agents where this feature is not supported, this attribute will be ignored. Use this feature as an additional layer of protection or check if the browser supports sandboxed frames and only show the untrusted content if supported.</li>
<li>Apart from this attribute, to prevent Clickjacking attacks and unsolicited framing it is encouraged to use the header <code>X-Frame-Options</code> which supports the <code>deny</code> and <code>same-origin</code> values. Other solutions like framebusting <code>if(window!==window.top) { window.top.location=location;}</code> are not recommended.</li>
</ul>
<h2 id="credential-and-personally-identifiable-information-pii-input-hints">Credential and Personally Identifiable Information (PII) Input hints<a class="headerlink" href="#credential-and-personally-identifiable-information-pii-input-hints" title="Permanent link">&para;</a></h2>
<ul>
<li>Protect the input values from being cached by the browser.</li>
</ul>
<blockquote>
<p>Access a financial account from a public computer. Even though one is logged-off, the next person who uses the machine can log-in because the browser autocomplete functionality. To mitigate this, we tell the input fields not to assist in any way.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">spellcheck</span><span class="o">=</span><span class="s">&quot;false&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;off&quot;</span> <span class="na">autocorrect</span><span class="o">=</span><span class="s">&quot;off&quot;</span> <span class="na">autocapitalize</span><span class="o">=</span><span class="s">&quot;off&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">input</span><span class="p">&gt;</span>
</code></pre></div>

<p>Text areas and input fields for PII (name, email, address, phone number) and login credentials (username, password) should be prevented from being stored in the browser. Use these HTML5 attributes to prevent the browser from storing PII from your form:</p>
<ul>
<li><code>spellcheck="false"</code></li>
<li><code>autocomplete="off"</code></li>
<li><code>autocorrect="off"</code></li>
<li><code>autocapitalize="off"</code></li>
</ul>
<h2 id="offline-applications">Offline Applications<a class="headerlink" href="#offline-applications" title="Permanent link">&para;</a></h2>
<ul>
<li>Whether the user agent requests permission from the user to store data for offline browsing and when this cache is deleted, varies from one browser to the next. Cache poisoning is an issue if a user connects through insecure networks, so for privacy reasons it is encouraged to require user input before sending any <code>manifest</code> file.</li>
<li>Users should only cache trusted websites and clean the cache after browsing through open or insecure networks.</li>
</ul>
<h2 id="progressive-enhancements-and-graceful-degradation-risks">Progressive Enhancements and Graceful Degradation Risks<a class="headerlink" href="#progressive-enhancements-and-graceful-degradation-risks" title="Permanent link">&para;</a></h2>
<ul>
<li>The best practice now is to determine the capabilities that a browser supports and augment with some type of substitute for capabilities that are not directly supported. This may mean an onion-like element, e.g. falling through to a Flash Player if the <code>&lt;video&gt;</code> tag is unsupported, or it may mean additional scripting code from various sources that should be code reviewed.</li>
</ul>
<h2 id="http-headers-to-enhance-security">HTTP Headers to enhance security<a class="headerlink" href="#http-headers-to-enhance-security" title="Permanent link">&para;</a></h2>
<p>Consult the project <a href="https://owasp.org/www-project-secure-headers/">OWASP Secure Headers</a> in order to obtains the list of HTTP security headers that an application should use to enable defenses at browser level.</p>
<h2 id="websocket-implementation-hints">WebSocket implementation hints<a class="headerlink" href="#websocket-implementation-hints" title="Permanent link">&para;</a></h2>
<p>In addition to the elements mentioned above, this is the list of areas for which caution must be taken during the implementation.</p>
<ul>
<li>Access filtering through the "Origin" HTTP request header</li>
<li>Input / Output validation</li>
<li>Authentication</li>
<li>Authorization</li>
<li>Access token explicit invalidation</li>
<li>Confidentiality and Integrity</li>
</ul>
<p>The section below will propose some implementation hints for every area and will go along with an application example showing all the points described.</p>
<p>The complete source code of the example application is available <a href="https://github.com/righettod/poc-websocket">here</a>.</p>
<h3 id="access-filtering">Access filtering<a class="headerlink" href="#access-filtering" title="Permanent link">&para;</a></h3>
<p>During a websocket channel initiation, the browser sends the <strong>Origin</strong> HTTP request header that contains the source domain initiation for the request to handshake. Even if this header can be spoofed in a forged HTTP request (not browser based), it cannot be overridden or forced in a browser context. It then represents a good candidate to apply filtering according to an expected value.</p>
<p>An example of an attack using this vector, named <em>Cross-Site WebSocket Hijacking (CSWSH)</em>, is described <a href="https://www.christian-schneider.net/CrossSiteWebSocketHijacking.html">here</a>.</p>
<p>The code below defines a configuration that applies filtering based on a "whitelist" of origins. This ensures that only allowed origins can establish a full handshake:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.owasp.encoder.Encode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.websocket.server.ServerEndpointConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Setup handshake rules applied to all WebSocket endpoints of the application.</span>
<span class="cm"> * Use to setup the Access Filtering using &quot;Origin&quot; HTTP header as input information.</span>
<span class="cm"> *</span>
<span class="cm"> * @see &quot;http://docs.oracle.com/javaee/7/api/index.html?javax/websocket/server/</span>
<span class="cm"> * ServerEndpointConfig.Configurator.html&quot;</span>
<span class="cm"> * @see &quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin&quot;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EndpointConfigurator</span> <span class="kd">extends</span> <span class="n">ServerEndpointConfig</span><span class="p">.</span><span class="na">Configurator</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Logger</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">EndpointConfigurator</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the expected source origins from a JVM property in order to allow external configuration</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">EXPECTED_ORIGINS</span> <span class="o">=</span>  <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&quot;source.origins&quot;</span><span class="p">)</span>
                                                          <span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">));</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkOrigin</span><span class="p">(</span><span class="n">String</span> <span class="n">originHeaderValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">boolean</span> <span class="n">isAllowed</span> <span class="o">=</span> <span class="n">EXPECTED_ORIGINS</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">originHeaderValue</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">safeOriginValue</span> <span class="o">=</span> <span class="n">Encode</span><span class="p">.</span><span class="na">forHtmlContent</span><span class="p">(</span><span class="n">originHeaderValue</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isAllowed</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[EndpointConfigurator] New handshake request received from {} and was accepted.&quot;</span><span class="p">,</span>
                      <span class="n">safeOriginValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;[EndpointConfigurator] New handshake request received from {} and was rejected !&quot;</span><span class="p">,</span>
                      <span class="n">safeOriginValue</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">isAllowed</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<h3 id="authentication-and-inputoutput-validation">Authentication and Input/Output validation<a class="headerlink" href="#authentication-and-inputoutput-validation" title="Permanent link">&para;</a></h3>
<p>When using websocket as communication channel, it's important to use an authentication method allowing the user to receive an access <em>Token</em> that is not automatically sent by the browser and then must be explicitly sent by the client code during each exchange.</p>
<p><a href="https://jwt.io/introduction/">JSON Web Token</a> is a good candidate, because it allows the transport of access ticket information in a stateless and not alterable way. Moreover, it defines a validity timeframe. You can find additional information about JWT token hardening on this <a href="JSON_Web_Token_for_Java_Cheat_Sheet.html">cheat sheet</a>.</p>
<p><a href="http://json-schema.org/">JSON Validation Schema</a> are used to define and validate the expected content in input and ouput messages.</p>
<p>The code below defines the complete authentication messages flow handling:</p>
<p><strong>Authentication Web Socket endpoint</strong> - Provide a WS endpoint that enables authentication exchange</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.configurator.EndpointConfigurator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.decoder.AuthenticationRequestDecoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.encoder.AuthenticationResponseEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.handler.AuthenticationMessageHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.websocket.CloseReason</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnClose</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnOpen</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.Session</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.server.ServerEndpoint</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Class in charge of managing the client authentication.</span>
<span class="cm"> *</span>
<span class="cm"> * @see &quot;http://docs.oracle.com/javaee/7/api/javax/websocket/server/ServerEndpointConfig.Configurator.html&quot;</span>
<span class="cm"> * @see &quot;http://svn.apache.org/viewvc/tomcat/trunk/webapps/examples/WEB-INF/classes/websocket/&quot;</span>
<span class="cm"> */</span>
<span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/auth&quot;</span><span class="p">,</span> <span class="n">configurator</span> <span class="o">=</span> <span class="n">EndpointConfigurator</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<span class="n">subprotocols</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;authentication&quot;</span><span class="p">},</span> <span class="n">encoders</span> <span class="o">=</span> <span class="p">{</span><span class="n">AuthenticationResponseEncoder</span><span class="p">.</span><span class="na">class</span><span class="p">},</span>
<span class="n">decoders</span> <span class="o">=</span> <span class="p">{</span><span class="n">AuthenticationRequestDecoder</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEndpoint</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Logger</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">AuthenticationEndpoint</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * Handle the beginning of an exchange</span>
<span class="cm">     *</span>
<span class="cm">     * @param session Exchange session information</span>
<span class="cm">     */</span>
    <span class="nd">@OnOpen</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Define connection idle timeout and message limits in order to mitigate as much as possible</span>
        <span class="c1">//DOS attacks using massive connection opening or massive big messages sending</span>
        <span class="kt">int</span> <span class="n">msgMaxSize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span><span class="c1">//1 MB</span>
        <span class="n">session</span><span class="p">.</span><span class="na">setMaxIdleTimeout</span><span class="p">(</span><span class="mi">60000</span><span class="p">);</span><span class="c1">//1 minute</span>
        <span class="n">session</span><span class="p">.</span><span class="na">setMaxTextMessageBufferSize</span><span class="p">(</span><span class="n">msgMaxSize</span><span class="p">);</span>
        <span class="n">session</span><span class="p">.</span><span class="na">setMaxBinaryMessageBufferSize</span><span class="p">(</span><span class="n">msgMaxSize</span><span class="p">);</span>
        <span class="c1">//Log exchange start</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Session {} started&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="c1">//Affect a new message handler instance in order to process the exchange</span>
        <span class="n">session</span><span class="p">.</span><span class="na">addMessageHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthenticationMessageHandler</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">()));</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Session {} message handler affected for processing&quot;</span><span class="p">,</span>
                  <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Handle error case</span>
<span class="cm">     *</span>
<span class="cm">     * @param session Exchange session information</span>
<span class="cm">     * @param thr     Error details</span>
<span class="cm">     */</span>
    <span class="nd">@OnError</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">Throwable</span> <span class="n">thr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Error occur in session {}&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">thr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Handle close event</span>
<span class="cm">     *</span>
<span class="cm">     * @param session     Exchange session information</span>
<span class="cm">     * @param closeReason Exchange closing reason</span>
<span class="cm">     */</span>
    <span class="nd">@OnClose</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">CloseReason</span> <span class="n">closeReason</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Session {} closed: {}&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span>
                  <span class="n">closeReason</span><span class="p">.</span><span class="na">getReasonPhrase</span><span class="p">());</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p><strong>Authentication message handler</strong> - Handle all authentication requests</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.enumeration.AccessLevel</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.util.AuthenticationUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.vo.AuthenticationRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.vo.AuthenticationResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.encoder.Encode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.websocket.EncodeException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.MessageHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.RemoteEndpoint</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Handle authentication message flow</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationMessageHandler</span> <span class="kd">implements</span> <span class="n">MessageHandler</span><span class="p">.</span><span class="na">Whole</span><span class="o">&lt;</span><span class="n">AuthenticationRequest</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">AuthenticationMessageHandler</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * Reference to the communication channel with the client</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">RemoteEndpoint</span><span class="p">.</span><span class="na">Basic</span> <span class="n">clientConnection</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Constructor</span>
<span class="cm">     *</span>
<span class="cm">     * @param clientConnection Reference to the communication channel with the client</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">AuthenticationMessageHandler</span><span class="p">(</span><span class="n">RemoteEndpoint</span><span class="p">.</span><span class="na">Basic</span> <span class="n">clientConnection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">clientConnection</span> <span class="o">=</span> <span class="n">clientConnection</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">AuthenticationRequest</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">AuthenticationResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//Authenticate</span>
            <span class="n">String</span> <span class="n">authenticationToken</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
            <span class="n">String</span> <span class="n">accessLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getLogin</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">accessLevel</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//Create a simple JSON token representing the authentication profile</span>
                <span class="n">authenticationToken</span> <span class="o">=</span> <span class="n">AuthenticationUtils</span><span class="p">.</span><span class="na">issueToken</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getLogin</span><span class="p">(),</span> <span class="n">accessLevel</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">//Build the response object</span>
            <span class="n">String</span> <span class="n">safeLoginValue</span> <span class="o">=</span> <span class="n">Encode</span><span class="p">.</span><span class="na">forHtmlContent</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getLogin</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">authenticationToken</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthenticationResponse</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">authenticationToken</span><span class="p">,</span> <span class="s">&quot;Authentication succeed !&quot;</span><span class="p">);</span>
                <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[AuthenticationMessageHandler] User {} authentication succeed.&quot;</span><span class="p">,</span> <span class="n">safeLoginValue</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthenticationResponse</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">authenticationToken</span><span class="p">,</span> <span class="s">&quot;Authentication failed !&quot;</span><span class="p">);</span>
                <span class="n">LOG</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;[AuthenticationMessageHandler] User {} authentication failed.&quot;</span><span class="p">,</span> <span class="n">safeLoginValue</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;[AuthenticationMessageHandler] Error occur in authentication process.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="c1">//Build the response object indicating that authentication fail</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthenticationResponse</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Authentication failed !&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="c1">//Send response</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">clientConnection</span><span class="p">.</span><span class="na">sendObject</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">EncodeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;[AuthenticationMessageHandler] Error occur in response object sending.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Authenticate the user</span>
<span class="cm">     *</span>
<span class="cm">     * @param login    User login</span>
<span class="cm">     * @param password User password</span>
<span class="cm">     * @return The access level if the authentication succeed or NULL if the authentication failed</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">String</span> <span class="n">login</span><span class="p">,</span> <span class="n">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">....</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Utility class to manage JWT token</strong> - Handle the issuing and the validation of the access token. Simple JWT token has been used for the example (focus was made here on the global WS endpoint implementation) here without extra hardening (see this <a href="JSON_Web_Token_for_Java_Cheat_Sheet.html">cheat sheet</a> to apply extra hardening on the JWT token)</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">com.auth0.jwt.JWT</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.JWTVerifier</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.algorithms.Algorithm</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.interfaces.DecodedJWT</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Calendar</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Utility class to manage the authentication JWT token</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationUtils</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Build a JWT token for a user</span>
<span class="cm">     *</span>
<span class="cm">     * @param login       User login</span>
<span class="cm">     * @param accessLevel Access level of the user</span>
<span class="cm">     * @return The Base64 encoded JWT token</span>
<span class="cm">     * @throws Exception If any error occur during the issuing</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">issueToken</span><span class="p">(</span><span class="n">String</span> <span class="n">login</span><span class="p">,</span> <span class="n">String</span> <span class="n">accessLevel</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//Issue a JWT token with validity of 30 minutes</span>
        <span class="n">Algorithm</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="n">Algorithm</span><span class="p">.</span><span class="na">HMAC256</span><span class="p">(</span><span class="n">loadSecret</span><span class="p">());</span>
        <span class="n">Calendar</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Calendar</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
        <span class="n">c</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">Calendar</span><span class="p">.</span><span class="na">MINUTE</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">JWT</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">withIssuer</span><span class="p">(</span><span class="s">&quot;WEBSOCKET-SERVER&quot;</span><span class="p">).</span><span class="na">withSubject</span><span class="p">(</span><span class="n">login</span><span class="p">).</span><span class="na">withExpiresAt</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="na">getTime</span><span class="p">())</span>
                  <span class="p">.</span><span class="na">withClaim</span><span class="p">(</span><span class="s">&quot;access_level&quot;</span><span class="p">,</span> <span class="n">accessLevel</span><span class="p">.</span><span class="na">trim</span><span class="p">().</span><span class="na">toUpperCase</span><span class="p">(</span><span class="n">Locale</span><span class="p">.</span><span class="na">US</span><span class="p">)).</span><span class="na">sign</span><span class="p">(</span><span class="n">algorithm</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Verify the validity of the provided JWT token</span>
<span class="cm">     *</span>
<span class="cm">     * @param token JWT token encoded to verify</span>
<span class="cm">     * @return The verified and decoded token with user authentication and</span>
<span class="cm">     * authorization (access level) information</span>
<span class="cm">     * @throws Exception If any error occur during the token validation</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">DecodedJWT</span> <span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span> <span class="n">token</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Algorithm</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="n">Algorithm</span><span class="p">.</span><span class="na">HMAC256</span><span class="p">(</span><span class="n">loadSecret</span><span class="p">());</span>
        <span class="n">JWTVerifier</span> <span class="n">verifier</span> <span class="o">=</span> <span class="n">JWT</span><span class="p">.</span><span class="na">require</span><span class="p">(</span><span class="n">algorithm</span><span class="p">).</span><span class="na">withIssuer</span><span class="p">(</span><span class="s">&quot;WEBSOCKET-SERVER&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">verifier</span><span class="p">.</span><span class="na">verify</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Load the JWT secret used to sign token using a byte array for secret storage in order</span>
<span class="cm">     * to avoid persistent string in memory</span>
<span class="cm">     *</span>
<span class="cm">     * @return The secret as byte array</span>
<span class="cm">     * @throws IOException If any error occur during the secret loading</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">loadSecret</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Files</span><span class="p">.</span><span class="na">readAllBytes</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;src&quot;</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;resources&quot;</span><span class="p">,</span> <span class="s">&quot;jwt-secret.txt&quot;</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>JSON schema of the input and output authentication message</strong> - Define the expected structure of the input and output messages from the authentication endpoint point of view</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/schema#&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;AuthenticationRequest&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;login&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^[a-zA-Z]{1,10}$&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;login&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="p">{</span>
<span class="nt">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/schema#&quot;</span><span class="p">,</span>
<span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;AuthenticationResponse&quot;</span><span class="p">,</span>
<span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;isSuccess;&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^[a-zA-Z0-9+/=\\._-]{0,500}$&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^[a-zA-Z0-9!\\s]{0,100}$&quot;</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;isSuccess&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token&quot;</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span>
<span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Authentication message decoder and encoder</strong> - Perform the JSON serialization/deserialization and the input/output validation using dedicated JSON Schema. It makes it possible to systematically ensure that all messages received and sent by the endpoint strictly respect the expected structure and content.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.JsonNode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jackson.JsonLoader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.core.exceptions.ProcessingException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.core.report.ProcessingReport</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.main.JsonSchema</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.main.JsonSchemaFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.vo.AuthenticationRequest</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.websocket.DecodeException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.Decoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.EndpointConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Decode JSON text representation to an AuthenticationRequest object</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * As there&#39;s one instance of the decoder class by endpoint session so we can use the</span>
<span class="cm"> * JsonSchema as decoder instance variable.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationRequestDecoder</span> <span class="kd">implements</span> <span class="n">Decoder</span><span class="p">.</span><span class="na">Text</span><span class="o">&lt;</span><span class="n">AuthenticationRequest</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * JSON validation schema associated to this type of message</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">JsonSchema</span> <span class="n">validationSchema</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Initialize decoder and associated JSON validation schema</span>
<span class="cm">     *</span>
<span class="cm">     * @throws IOException If any error occur during the object creation</span>
<span class="cm">     * @throws ProcessingException If any error occur during the schema loading</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">AuthenticationRequestDecoder</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ProcessingException</span> <span class="p">{</span>
        <span class="n">JsonNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">JsonLoader</span><span class="p">.</span><span class="na">fromFile</span><span class="p">(</span>
                        <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;src/main/resources/authentication-request-schema.json&quot;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="na">validationSchema</span> <span class="o">=</span> <span class="n">JsonSchemaFactory</span><span class="p">.</span><span class="na">byDefault</span><span class="p">().</span><span class="na">getJsonSchema</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">AuthenticationRequest</span> <span class="nf">decode</span><span class="p">(</span><span class="n">String</span> <span class="n">s</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">DecodeException</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//Validate the provided representation against the dedicated schema</span>
            <span class="c1">//Use validation mode with report in order to enable further inspection/tracing</span>
            <span class="c1">//of the error details</span>
            <span class="c1">//Moreover the validation method &quot;validInstance()&quot; generate a NullPointerException</span>
            <span class="c1">//if the representation do not respect the expected schema</span>
            <span class="c1">//so it&#39;s more proper to use the validation method with report</span>
            <span class="n">ProcessingReport</span> <span class="n">validationReport</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">validationSchema</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">JsonLoader</span><span class="p">.</span><span class="na">fromString</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
                                                                               <span class="kc">true</span><span class="p">);</span>
            <span class="c1">//Ensure there no error</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">validationReport</span><span class="p">.</span><span class="na">isSuccess</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">//Simply reject the message here: Don&#39;t care about error details...</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">DecodeException</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Validation of the provided representation failed !&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">ProcessingException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">DecodeException</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Cannot validate the provided representation to a&quot;</span>
                                      <span class="o">+</span> <span class="s">&quot; JSON valid representation !&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">Gson</span><span class="p">().</span><span class="na">fromJson</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AuthenticationRequest</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">willDecode</span><span class="p">(</span><span class="n">String</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">boolean</span> <span class="n">canDecode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="c1">//If the provided JSON representation is empty/null then we indicate that</span>
        <span class="c1">//representation cannot be decoded to our expected object</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="na">trim</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">canDecode</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Try to cast the provided JSON representation to our object to validate at least</span>
        <span class="c1">//the structure (content validation is done during decoding)</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">AuthenticationRequest</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="p">().</span><span class="na">fromJson</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AuthenticationRequest</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="n">canDecode</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Ignore explicitly any casting error...</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">canDecode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="n">EndpointConfig</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Not used</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//Not used</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.JsonNode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jackson.JsonLoader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.core.exceptions.ProcessingException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.core.report.ProcessingReport</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.main.JsonSchema</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.fge.jsonschema.main.JsonSchemaFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.vo.AuthenticationResponse</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.websocket.EncodeException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.Encoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.EndpointConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Encode AuthenticationResponse object to JSON text representation.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * As there one instance of the encoder class by endpoint session so we can use</span>
<span class="cm"> * the JsonSchema as encoder instance variable.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationResponseEncoder</span> <span class="kd">implements</span> <span class="n">Encoder</span><span class="p">.</span><span class="na">Text</span><span class="o">&lt;</span><span class="n">AuthenticationResponse</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * JSON validation schema associated to this type of message</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">JsonSchema</span> <span class="n">validationSchema</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Initialize encoder and associated JSON validation schema</span>
<span class="cm">     *</span>
<span class="cm">     * @throws IOException If any error occur during the object creation</span>
<span class="cm">     * @throws ProcessingException If any error occur during the schema loading</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">AuthenticationResponseEncoder</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ProcessingException</span> <span class="p">{</span>
        <span class="n">JsonNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">JsonLoader</span><span class="p">.</span><span class="na">fromFile</span><span class="p">(</span>
                        <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;src/main/resources/authentication-response-schema.json&quot;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="na">validationSchema</span> <span class="o">=</span> <span class="n">JsonSchemaFactory</span><span class="p">.</span><span class="na">byDefault</span><span class="p">().</span><span class="na">getJsonSchema</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">encode</span><span class="p">(</span><span class="n">AuthenticationResponse</span> <span class="n">object</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">EncodeException</span> <span class="p">{</span>
        <span class="c1">//Generate the JSON representation</span>
        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="p">().</span><span class="na">toJson</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//Validate the generated representation against the dedicated schema</span>
            <span class="c1">//Use validation mode with report in order to enable further inspection/tracing</span>
            <span class="c1">//of the error details</span>
            <span class="c1">//Moreover the validation method &quot;validInstance()&quot; generate a NullPointerException</span>
            <span class="c1">//if the representation do not respect the expected schema</span>
            <span class="c1">//so it&#39;s more proper to use the validation method with report</span>
            <span class="n">ProcessingReport</span> <span class="n">validationReport</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">validationSchema</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">JsonLoader</span><span class="p">.</span><span class="na">fromString</span><span class="p">(</span><span class="n">json</span><span class="p">),</span>
                                                                                <span class="kc">true</span><span class="p">);</span>
            <span class="c1">//Ensure there no error</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">validationReport</span><span class="p">.</span><span class="na">isSuccess</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">//Simply reject the message here: Don&#39;t care about error details...</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">EncodeException</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="s">&quot;Validation of the generated representation failed !&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">ProcessingException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">EncodeException</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="s">&quot;Cannot validate the generated representation to a&quot;</span><span class="o">+</span>
                                              <span class="s">&quot; JSON valid representation !&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">json</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="n">EndpointConfig</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Not used</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//Not used</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p>Note that the same approach is used in the messages handling part of the POC. All messages exchanged between the client and the server are systematically validated using the same way, using dedicated JSON schemas linked to messages dedicated Encoder/Decoder (serialization/deserialization).</p>
<h3 id="authorization-and-access-token-explicit-invalidation">Authorization and access token explicit invalidation<a class="headerlink" href="#authorization-and-access-token-explicit-invalidation" title="Permanent link">&para;</a></h3>
<p>Authorization information is stored in the access token using the JWT <em>Claim</em> feature (in the POC the name of the claim is <em>access_level</em>). Authorization is validated when a request is received and before any other action using the user input information.</p>
<p>The access token is passed with every message sent to the message endpoint and a blacklist is used in order to allow the user to request an explicit token invalidation.</p>
<p>Explicit token invalidation is interesting from a user's point of view because, often when tokens are used, the validity timeframe of the token is relatively long (it's common to see a valid timeframe superior to 1 hour) so it's important to allow a user to have a way to indicate to the system "OK, I have finished my exchange with you, so you can close our exchange session and cleanup associated links".</p>
<p>It also helps the user to revoke itself of current access if a malicious concurrent access is detected using the same token (case of token stealing).</p>
<p><strong>Token blacklist</strong> - Maintain a temporary list using memory and time limited Caching of hashes of token that are not allowed to be used anymore</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.commons.jcs.JCS</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.jcs.access.CacheAccess</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.jcs.access.exception.CacheException</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.bind.DatatypeConverter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.security.NoSuchAlgorithmException</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Utility class to manage the access token that have been declared as no</span>
<span class="cm"> * more usable (explicit user logout)</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessTokenBlacklistUtils</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Message content send by user that indicate that the access token that</span>
<span class="cm">     * come along the message must be blacklisted for further usage</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MESSAGE_ACCESS_TOKEN_INVALIDATION_FLAG</span> <span class="o">=</span> <span class="s">&quot;INVALIDATE_TOKEN&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Use cache to store blacklisted token hash in order to avoid memory exhaustion and be consistent</span>
<span class="cm">     * because token are valid 30 minutes so the item live in cache 60 minutes</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CacheAccess</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">TOKEN_CACHE</span><span class="p">;</span>

    <span class="kd">static</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">TOKEN_CACHE</span> <span class="o">=</span> <span class="n">JCS</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">CacheException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Cannot init token cache !&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Add token into the blacklist</span>
<span class="cm">     *</span>
<span class="cm">     * @param token Token for which the hash must be added</span>
<span class="cm">     * @throws NoSuchAlgorithmException If SHA256 is not available</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addToken</span><span class="p">(</span><span class="n">String</span> <span class="n">token</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">NoSuchAlgorithmException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">token</span><span class="p">.</span><span class="na">trim</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">hashHex</span> <span class="o">=</span> <span class="n">computeHash</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">TOKEN_CACHE</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">hashHex</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">TOKEN_CACHE</span><span class="p">.</span><span class="na">putSafe</span><span class="p">(</span><span class="n">hashHex</span><span class="p">,</span> <span class="n">hashHex</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Check if a token is present in the blacklist</span>
<span class="cm">     *</span>
<span class="cm">     * @param token Token for which the presence of the hash must be verified</span>
<span class="cm">     * @return TRUE if token is blacklisted</span>
<span class="cm">     * @throws NoSuchAlgorithmException If SHA256 is not available</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isBlacklisted</span><span class="p">(</span><span class="n">String</span> <span class="n">token</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">NoSuchAlgorithmException</span> <span class="p">{</span>
        <span class="kt">boolean</span> <span class="n">exists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">token</span><span class="p">.</span><span class="na">trim</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">hashHex</span> <span class="o">=</span> <span class="n">computeHash</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="p">(</span><span class="n">TOKEN_CACHE</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">hashHex</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">exists</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Compute the SHA256 hash of a token</span>
<span class="cm">     *</span>
<span class="cm">     * @param token Token for which the hash must be computed</span>
<span class="cm">     * @return The hash encoded in HEX</span>
<span class="cm">     * @throws NoSuchAlgorithmException If SHA256 is not available</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">computeHash</span><span class="p">(</span><span class="n">String</span> <span class="n">token</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">NoSuchAlgorithmException</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">hashHex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">token</span><span class="p">.</span><span class="na">trim</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">MessageDigest</span> <span class="n">md</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;SHA-256&quot;</span><span class="p">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">md</span><span class="p">.</span><span class="na">digest</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
            <span class="n">hashHex</span> <span class="o">=</span> <span class="n">DatatypeConverter</span><span class="p">.</span><span class="na">printHexBinary</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">hashHex</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p><strong>Message handling</strong> - Process a request from a user to add a message in the list. Show a authorization validation approach example</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">com.auth0.jwt.interfaces.Claim</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.interfaces.DecodedJWT</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.enumeration.AccessLevel</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.util.AccessTokenBlacklistUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.util.AuthenticationUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.util.MessageUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.vo.MessageRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.owasp.pocwebsocket.vo.MessageResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.websocket.EncodeException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.RemoteEndpoint</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Handle message flow</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageHandler</span> <span class="kd">implements</span> <span class="n">javax</span><span class="p">.</span><span class="na">websocket</span><span class="p">.</span><span class="na">MessageHandler</span><span class="p">.</span><span class="na">Whole</span><span class="o">&lt;</span><span class="n">MessageRequest</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">MessageHandler</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * Reference to the communication channel with the client</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">RemoteEndpoint</span><span class="p">.</span><span class="na">Basic</span> <span class="n">clientConnection</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Constructor</span>
<span class="cm">     *</span>
<span class="cm">     * @param clientConnection Reference to the communication channel with the client</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">MessageHandler</span><span class="p">(</span><span class="n">RemoteEndpoint</span><span class="p">.</span><span class="na">Basic</span> <span class="n">clientConnection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">clientConnection</span> <span class="o">=</span> <span class="n">clientConnection</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">MessageRequest</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MessageResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="cm">/*Step 1: Verify the token*/</span>
            <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">getToken</span><span class="p">();</span>
            <span class="c1">//Verify if is it in the blacklist</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">AccessTokenBlacklistUtils</span><span class="p">.</span><span class="na">isBlacklisted</span><span class="p">(</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalAccessException</span><span class="p">(</span><span class="s">&quot;Token is in the blacklist !&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">//Verify the signature of the token</span>
            <span class="n">DecodedJWT</span> <span class="n">decodedToken</span> <span class="o">=</span> <span class="n">AuthenticationUtils</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

            <span class="cm">/*Step 2: Verify the authorization (access level)*/</span>
            <span class="n">Claim</span> <span class="n">accessLevel</span> <span class="o">=</span> <span class="n">decodedToken</span><span class="p">.</span><span class="na">getClaim</span><span class="p">(</span><span class="s">&quot;access_level&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">accessLevel</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">AccessLevel</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">accessLevel</span><span class="p">.</span><span class="na">asString</span><span class="p">())</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalAccessException</span><span class="p">(</span><span class="s">&quot;Token have an invalid access level claim !&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="cm">/*Step 3: Do the expected processing*/</span>
            <span class="c1">//Init the list of the messages for the current user</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MessageUtils</span><span class="p">.</span><span class="na">MESSAGES_DB</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">decodedToken</span><span class="p">.</span><span class="na">getSubject</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">MessageUtils</span><span class="p">.</span><span class="na">MESSAGES_DB</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">decodedToken</span><span class="p">.</span><span class="na">getSubject</span><span class="p">(),</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="c1">//Add message to the list of message of the user if the message is a not a token invalidation</span>
            <span class="c1">//order otherwise add the token to the blacklist</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">AccessTokenBlacklistUtils</span><span class="p">.</span><span class="na">MESSAGE_ACCESS_TOKEN_INVALIDATION_FLAG</span>
                <span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getContent</span><span class="p">().</span><span class="na">trim</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">AccessTokenBlacklistUtils</span><span class="p">.</span><span class="na">addToken</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getToken</span><span class="p">());</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">MessageUtils</span><span class="p">.</span><span class="na">MESSAGES_DB</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">decodedToken</span><span class="p">.</span><span class="na">getSubject</span><span class="p">()).</span><span class="na">add</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getContent</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="c1">//According to the access level of user either return only is message or return all message</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">messages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">accessLevel</span><span class="p">.</span><span class="na">asString</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">AccessLevel</span><span class="p">.</span><span class="na">USER</span><span class="p">.</span><span class="na">name</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">MessageUtils</span><span class="p">.</span><span class="na">MESSAGES_DB</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">decodedToken</span><span class="p">.</span><span class="na">getSubject</span><span class="p">())</span>
                <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;(%s): %s&quot;</span><span class="p">,</span> <span class="n">decodedToken</span><span class="p">.</span><span class="na">getSubject</span><span class="p">(),</span> <span class="n">s</span><span class="p">)));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">accessLevel</span><span class="p">.</span><span class="na">asString</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">AccessLevel</span><span class="p">.</span><span class="na">ADMIN</span><span class="p">.</span><span class="na">name</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">MessageUtils</span><span class="p">.</span><span class="na">MESSAGES_DB</span><span class="p">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">v</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;(%s): %s&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">))));</span>
            <span class="p">}</span>

            <span class="c1">//Build the response object indicating that exchange succeed</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">AccessTokenBlacklistUtils</span><span class="p">.</span><span class="na">MESSAGE_ACCESS_TOKEN_INVALIDATION_FLAG</span>
                <span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getContent</span><span class="p">().</span><span class="na">trim</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageResponse</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="s">&quot;Token added to the blacklist&quot;</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageResponse</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;[MessageHandler] Error occur in exchange process.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="c1">//Build the response object indicating that exchange fail</span>
            <span class="c1">//We send the error detail on client because ware are in POC (it will not the case in a real app)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageResponse</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(),</span> <span class="s">&quot;Error occur during exchange: &quot;</span>
                       <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="c1">//Send response</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="na">clientConnection</span><span class="p">.</span><span class="na">sendObject</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">EncodeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;[MessageHandler] Error occur in response object sending.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="confidentiality-and-integrity">Confidentiality and Integrity<a class="headerlink" href="#confidentiality-and-integrity" title="Permanent link">&para;</a></h3>
<p>If the raw version of the protocol is used (protocol <code>ws://</code>) then the transferred data is exposed to eavesdropping and potential on-the-fly alteration.</p>
<p>Example of capture using <a href="https://www.wireshark.org/">Wireshark</a> and searching for password exchanges in the stored PCAP file, not printable characters has been explicitly removed from the command result:</p>
<div class="codehilite"><pre><span></span><code>$ grep -aE <span class="s1">&#39;(password)&#39;</span> capture.pcap
<span class="o">{</span><span class="s2">&quot;login&quot;</span>:<span class="s2">&quot;bob&quot;</span>,<span class="s2">&quot;password&quot;</span>:<span class="s2">&quot;bob123&quot;</span><span class="o">}</span>
</code></pre></div>

<p>There is a way to check, at WebSocket endpoint level, if the channel is secure by calling the method <code>isSecure()</code> on the <em>session</em> object instance.</p>
<p>Example of implementation in the method of the endpoint in charge of setup of the session and affects the message handler:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Handle the beginning of an exchange</span>
<span class="cm"> *</span>
<span class="cm"> * @param session Exchange session information</span>
<span class="cm"> */</span>
<span class="nd">@OnOpen</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">//Affect a new message handler instance in order to process the exchange only if the channel is secured</span>
    <span class="k">if</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="na">isSecure</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">session</span><span class="p">.</span><span class="na">addMessageHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthenticationMessageHandler</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">()));</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Session {} do not use a secure channel so no message handler &quot;</span> <span class="o">+</span>
                 <span class="s">&quot;was affected for processing and session was explicitly closed !&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="n">session</span><span class="p">.</span><span class="na">close</span><span class="p">(</span><span class="k">new</span> <span class="n">CloseReason</span><span class="p">(</span><span class="n">CloseReason</span><span class="p">.</span><span class="na">CloseCodes</span><span class="p">.</span><span class="na">CANNOT_ACCEPT</span><span class="p">,</span><span class="s">&quot;Insecure channel used !&quot;</span><span class="p">));</span>
        <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">){</span>
            <span class="n">LOG</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Session {} cannot be explicitly closed !&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span>
                      <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;[AuthenticationEndpoint] Session {} message handler affected for processing&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>

<p>Expose WebSocket endpoints only on <a href="https://kaazing.com/html5-websocket-security-is-strong/">wss://</a> protocol (WebSockets over SSL/TLS) in order to ensure <em>Confidentiality</em> and <em>Integrity</em> of the traffic like using HTTP over SSL/TLS to secure HTTP exchanges.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="GraphQL_Cheat_Sheet.html" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                GraphQL
              </div>
            </div>
          </a>
        
        
          <a href="HTTP_Strict_Transport_Security_Cheat_Sheet.html" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                HTTP Strict Transport Security
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            ©Copyright 2020 - CheatSheets Series Team
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>